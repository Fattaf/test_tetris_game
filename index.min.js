/*! release: 05-12-2014 */
var DrawAdapter=function(a){var b=a,c=b.getContext("2d");this.draw_image=function(a){var b=new Image;b.onload=function(){c.drawImage(b,70,50)},b.src=a},this.clear_canvas=function(){c.clearRect(0,0,b.width,b.height)},this.addScore=function(a){c.font="30pt Roboto sans-serif",c.fillStyle="#898181",c.fillText("Score: "+a,450,100)},this.addBorder=function(a,b,d,e){c.beginPath(),c.rect(a[0]-3,a[1]-3,b[0]+6,b[1]+6),this.addStroke(c,d,e)},this.addFill=function(a){c.fillStyle=a,c.fill()},this.addStroke=function(a,b){c.lineWidth=b,c.strokeStyle=a,c.stroke()},this.addFigure=function(a,b,d){void 0===b&&(b=10),void 0===d&&(d=10);var e=null,f=null;c.beginPath();for(var g=0;g<a.body.length;g++)e=b+Math.abs((a.position[0]+a.body[g][0])*a.figure_size[0]),f=d+Math.abs((a.position[1]+a.body[g][1])*a.figure_size[1]),c.rect(e,f,a.figure_size[0],a.figure_size[1])},this.addFieldBackground=function(a){c.beginPath(),e(a,function(a,b,c){d(a,b,c)}),this.addFill("#FFFFFF"),this.addStroke("#EDEDED",1)},this.drawFieldMarkedCells=function(a){c.beginPath(),e(a,function(a,b,c){1==a.miniMap[b][c]&&d(a,b,c)}),this.addFill("#9ED0FF"),this.addStroke("black",3)};var d=function(a,b,d){c.rect(a.disp*d+a.position[0],a.disp*b+a.position[1],40,40)},e=function(a,b){for(var c=0;c<a.miniMap.length;c++)for(var d=0;d<a.miniMap[c].length;d++)b(a,c,d)};return this},Field=function(a){this.position=[10,10],this.miniMap=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0]],this.disp=40,this.x_cells=10,this.y_cells=16;var b=this;this.drawField=function(){var c=[b.x_cells*b.disp,b.y_cells*b.disp];a.addBorder(b.position,c,"black",3),a.addFieldBackground(this),a.drawFieldMarkedCells(this)},this.isWillCover=function(a){for(var b=0;b<a.length;b++){var c=this.miniMap[a[b][1]][a[b][0]];if(1==c)return!0}return!1},this.addToCover=function(a){for(var b=0;b<a.length;b++)this.miniMap[a[b][1]][a[b][0]]=1},this.handleFullCoveredLines=function(){for(var a=[0,0,0,0,0,0,0,0,0,0],b=0,d=0;d<this.miniMap.length;d++)c(this.miniMap[d])&&(this.miniMap.splice(d,1),this.miniMap.unshift(a),b++);return b},this.isOverfilled=function(){for(var a=0;a<this.miniMap[1].length;a++)if(this.miniMap[1][a]>0)return!0;return!1};var c=function(a){var b=d(a);return b==a.length?!0:!1},d=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b};return this},Figure=function(a){this.position=[5,1],this.figure_size=[40,40],this.body=0/0,this.color=0/0;var b=this;this.drawFigure=function(b,c){a.addFigure(this,b,c),a.addFill(this.color),a.addStroke("black",2)},this.turn=function(a,b,c){if(this.position[0]>=b-1||this.position[0]<=a)return!1;var e=this.buildTurn(),f=d(e);return c.isWillCover(f)?!1:(this.body=e,!0)},this.pullLeft=function(a,b){var d=g()+this.position[0]-1;return c(b,[-1,0])?!1:a>d?!1:(this.position[0]-=1,!0)},this.pullRight=function(a,b){var d=e()+this.position[0]+1;return c(b,[1,0])?!1:d>=a?!1:(this.position[0]+=1,!0)},this.pullDown=function(a){var b=f()+this.position[1]+1;return b>=a.y_cells?!1:c(a,[0,1])?!1:(this.position[1]+=1,!0)},this.buildTurn=function(){for(var a=[],b=0;b<this.body.length;b++)a.push([this.body[b][1],-this.body[b][0]]);return a},this.countShape=function(a){void 0===a&&(a=[0,0]);for(var b=[],c=0;c<this.body.length;c++)b.push([this.body[c][0]+a[0]+this.position[0],this.body[c][1]+a[1]+this.position[1]]);return b};var c=function(a,c){var d=b.countShape(c);return a.isWillCover(d)},d=function(a){for(var c=[],d=0;d<a.length;d++)c.push([a[d][0]+b.position[0],a[d][1]+b.position[1]]);return c},e=function(){for(var a=[],c=0;c<b.body.length;c++)a.push(b.body[c][0]);return Math.max.apply(null,a)},f=function(){for(var a=[],c=0;c<b.body.length;c++)a.push(b.body[c][1]);return Math.max.apply(null,a)},g=function(){for(var a=[],c=0;c<b.body.length;c++)a.push(b.body[c][0]);return Math.min.apply(null,a)};return this},FigureBuilder=function(a){this.build=function(b){var c=new Figure(a);return i[b](c)},this.build_random_figure=function(){var b=new Figure(a),c=Math.floor(10*Math.random()%7)+1;return i["figureType"+c](b)};var b=function(a){return a.color="yellow",a.body=[[-1,0],[0,0],[1,0],[1,1]],a},c=function(a){return a.color="#1487F8",a.body=[[-1,0],[0,0],[1,0],[0,1]],a},d=function(a){return a.color="#0EEB1F",a.body=[[-1,0],[0,0],[0,1],[1,1]],a},e=function(a){return a.color="#FA4C23",a.body=[[-1,0],[0,0],[0,1],[-1,1]],a.turn=function(){return!0},a},f=function(a){return a.color="#DF30D9",a.body=[[-1,0],[0,0],[1,0],[2,0]],a.buildTurn=function(){for(var a=[],b=0;b<this.body.length;b++)a.push([this.body[b][1],this.body[b][0]]);return a},a},g=function(a){return a.color="#F50000",a.body=[[-1,0],[0,0],[1,0],[-1,1]],a},h=function(a){return a.color="#93E508",a.body=[[0,0],[1,0],[-1,1],[0,1]],a},i={figureType1:b,figureType2:c,figureType3:d,figureType4:e,figureType5:f,figureType6:g,figureType7:h};return this},Game=function(a,b){this.score=0,this.is_active=!0,this.imgs_bucket=b;var c=new DrawAdapter(a),d=new Field(c),e=new FigureBuilder(c),f=e.build_random_figure(),g=e.build_random_figure(),h=this;this.redraw=function(){c.clear_canvas(),d.drawField(),f.drawFigure(295,150),g.drawFigure(10,10),c.addScore(this.score)},this.animate=function(){if(0==this.is_active)return!1;0==g.pullDown(d)&&q(),this.redraw();var a=1e3-2*this.score;return setTimeout(function(){h.animate()},a),!0},this.keydownListener=function(a){if(0==this.is_active)return!1;switch(a){case 37:g.pullLeft(0,d);break;case 38:g.turn(0,d.x_cells,d);break;case 39:g.pullRight(d.x_cells,d);break;case 40:0==g.pullDown(d)&&q();break;default:return}this.redraw()};var i=function(){h.is_active=!1,c.draw_image(h.imgs_bucket.game_over)},j=function(a){h.score+=10*a},k=function(){h.score+=1},l=function(){g=f,f=e.build_random_figure()},m=function(a){2==a&&n(),a>=3&&o()},n=function(){console.log("Good!")},o=function(){console.log("Cool!")},p=function(){var a=d.handleFullCoveredLines();j(a),m(a)},q=function(){d.addToCover(g.countShape()),k(),p(),l(),d.isOverfilled()&&i()};return this};$(document).ready(function(){var a=$("#playground")[0],b={simlpe_encorage:"http://dc482.4shared.com/img/vpr5IWZY/s3/137a688eb20/awesome_face_17.gif",great_encorage:"http://fc00.deviantart.net/fs70/i/2011/044/5/8/my___awesome___face_by_daemonofdecay-d39fhp5.png",game_over:"http://typesetting.californiafonts.com/fonts/game-over/game-over.jpg"},c=new Game(a,b);c.animate(),$(document).on("keydown",function(a){c.keydownListener(a.which)})});